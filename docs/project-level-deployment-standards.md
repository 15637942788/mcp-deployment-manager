# 项目级部署标准功能

## 📋 功能概述

本系统现在支持**项目级部署标准**管理，确保每个MCP服务项目都有完整的部署标准约束，并自动同步最新的安全要求和配置保护规范。

## 🎯 主要功能

### 1. 自动标准检查
- **项目级检查**：部署时自动检查项目的 `.cursor/rules/` 目录下是否存在 `mcp-部署标准.mdc` 文件
- **标准验证**：验证项目标准文件的完整性和版本
- **内容检查**：确保包含最新的配置保护与备份要求

### 2. 智能标准同步
- **缺失自动复制**：如果项目缺少部署标准文件，自动从全局标准复制
- **版本自动更新**：检测到旧版本标准时，自动更新为最新版本（包含配置保护要求）
- **备份保护**：更新前自动备份原有标准文件

### 3. 完整性验证
- **文件大小检查**：确保标准文件不为空或过小（至少100字节）
- **关键内容验证**：检查是否包含"配置保护与备份要求"和"强制备份机制"
- **错误自动修复**：验证失败时自动重新同步

## 🔧 实现细节

### ensureDeploymentRules 函数增强

```typescript
async function ensureDeploymentRules(serverPath: string): Promise<{
  success: boolean;
  message: string;
  targetPath?: string;
  sourcePath?: string;
  projectStandardRequired?: boolean;  // 新增：是否需要项目标准
  projectStandardExists?: boolean;    // 新增：项目标准是否存在
  standardSynced?: boolean;           // 新增：是否进行了同步
}>
```

### 功能增强点

1. **项目根目录智能识别**
   - 从 `package.json`, `tsconfig.json`, `.git` 等标识文件推断项目根目录
   - 支持多种项目类型：Node.js, Python, Rust 等

2. **增强的标准文件验证**
   - 文件存在性检查
   - 文件完整性验证
   - 内容版本检查
   - 关键功能覆盖验证

3. **自动同步机制**
   - 缺失文件自动复制
   - 不完整文件重新同步
   - 旧版本自动更新
   - 错误情况自动修复

## 🛡️ 部署流程增强

### 新的部署检查序列

1. **部署标准检查**：验证项目是否包含部署标准文件，如无则自动复制
2. **配置备份创建**：强制创建当前配置的完整备份
3. **配置冲突检查**：检查是否存在同名服务器配置冲突
4. **静态代码扫描**：检查代码中的安全漏洞
5. **依赖安全检查**：验证所有依赖包的安全性
6. **配置文件检查**：确保无硬编码敏感信息
7. **权限验证**：确认服务运行的最小权限原则
8. **网络安全检查**：验证网络访问的合理性
9. **配置保护应用**：根据保护级别应用相应的保护策略
10. **部署后验证**：验证配置更新的完整性和正确性

## 📊 部署结果信息

部署完成后，系统会返回详细的项目级标准信息：

```json
{
  "projectLevelStandard": {
    "required": true,
    "exists": true,
    "synced": true,
    "message": "项目部署标准已更新为最新版本（包含配置保护要求），原文件已备份",
    "location": "/path/to/project/.cursor/rules/mcp-部署标准.mdc",
    "status": "已同步最新标准"
  }
}
```

## 🔍 状态说明

### required (boolean)
- `true`: 项目需要部署标准文件
- `false`: 项目不需要部署标准（极少情况）

### exists (boolean)
- `true`: 项目中已存在部署标准文件
- `false`: 项目中不存在部署标准文件

### synced (boolean)
- `true`: 执行了标准文件同步操作（复制、更新或修复）
- `false`: 使用了现有的项目标准文件

### status (string)
可能的状态：
- "已同步最新标准" - 执行了同步操作
- "使用现有项目标准" - 使用现有且正确的标准
- "项目标准缺失" - 项目标准文件不存在（错误状态）

## 📁 文件结构要求

每个MCP服务项目应包含以下结构：

```
your-mcp-project/
├── .cursor/
│   └── rules/
│       └── mcp-部署标准.mdc  ← 必需文件（自动管理）
├── src/
│   └── server.js|server.ts   ← MCP服务主文件
├── package.json              ← 依赖定义
├── README.md                 ← 项目文档
└── LICENSE                   ← 开源许可证
```

## ⚠️ 注意事项

1. **自动管理**：项目级标准文件由系统自动管理，不建议手动修改
2. **版本同步**：系统会自动保持项目标准与全局标准的同步
3. **备份保护**：更新标准文件前会自动创建备份
4. **错误恢复**：如遇到任何问题，系统会自动重新同步标准文件

## 🚀 使用示例

部署MCP服务时，系统会自动：

1. 检查项目根目录
2. 验证 `.cursor/rules/mcp-部署标准.mdc` 文件
3. 根据需要自动复制或更新标准文件
4. 返回详细的操作结果

用户无需手动干预，系统确保每个项目都有最新的部署标准。

---

**此功能确保了MCP服务生态的标准化和安全性，每个项目都具备完整的部署约束和安全要求。** 