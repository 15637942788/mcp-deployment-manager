# 全局安全策略升级 - 修复安全绕过漏洞

## 🚨 问题描述

**发现的严重安全漏洞**：原有的MCP部署安全机制依赖于每个项目本地的`.cursor/rules/mcp-部署标准.mdc`文件，这导致：

1. **可绕过安全检查**：新项目可以不包含这个文件而成功部署
2. **不一致的安全标准**：不同项目可能使用不同版本的安全标准
3. **依赖项目文件**：安全策略的执行依赖于用户是否正确维护项目文件

## 🔧 解决方案

### 1. 全局安全策略管理器

创建了`GlobalSecurityManager`类，实现：

- **单例模式**：确保全局唯一的安全策略管理器
- **独立于项目**：安全策略存储在MCP部署管理器自身，不依赖外部项目文件
- **强制执行**：所有MCP服务部署都必须通过全局安全检查

### 2. 架构改进

#### 之前（有漏洞）：
```
项目A/
├── .cursor/rules/
│   └── mcp-部署标准.mdc ← 可能缺失或过期
└── server.js

项目B/  ← 可能完全没有安全标准文件
└── server.js ← 可以绕过安全检查！
```

#### 现在（安全）：
```
MCP部署管理器/
├── config/
│   ├── global-security-policy.json    ← 全局策略
│   └── global-security-standards.json ← 全局标准
└── src/services/globalSecurityManager.ts

所有项目部署 → 强制通过全局安全检查 ← 无法绕过！
```

### 3. 核心修改

#### 新增文件：
- `src/services/globalSecurityManager.ts` - 全局安全策略管理器
- `config/global-security-policy.json` - 全局安全策略配置
- `config/global-security-standards.json` - 全局安全标准规则

#### 修改文件：
- `src/services/configService.ts` - 集成全局安全管理器
- `src/handlers/tools.ts` - 移除项目依赖，使用全局安全检查
- 所有部署工具描述 - 更新为反映全局策略

## 🛡️ 安全增强

### 全局安全策略特性

1. **强制执行**
   ```typescript
   // 永远不能跳过安全检查
   const globalSecurityResult = await this.globalSecurityManager.enforceGlobalSecurity(serverPath, projectRoot);
   ```

2. **多级保护**
   - 标准模式：最低评分85分
   - 严格模式：最低评分90分 + 所有检查必须通过
   - 可配置的评分门禁

3. **自动初始化**
   ```typescript
   // 服务启动时自动初始化全局策略
   await this.globalSecurityManager.initialize();
   ```

### 安全检查内容

- **代码安全**：危险函数、恶意命令、可疑模式
- **依赖安全**：漏洞检测、版本固定要求
- **配置安全**：硬编码敏感信息检测
- **权限安全**：文件权限、路径遍历检测

## 🔄 迁移指南

### 对现有用户的影响

1. **向后兼容**：现有的MCP服务仍然可以正常工作
2. **透明升级**：全局安全策略自动启用，无需手动配置
3. **项目文件可选**：不再需要在每个项目中维护安全标准文件

### 新工具

添加了`global_security_manager`工具：

```bash
# 查看全局安全策略状态
global_security_manager --action status

# 启用全局安全策略（严格模式）
global_security_manager --action enable --strictMode true

# 更新安全评分要求
global_security_manager --action update_policy --minimumScore 90
```

## 📊 安全评分系统

### 评分构成
- **代码安全 (40分)**：危险函数-15分，恶意命令-20分，可疑模式-5分
- **依赖安全 (30分)**：漏洞依赖-10分，未固定版本-2分
- **配置安全 (20分)**：硬编码敏感信息-10分，不安全配置-5分
- **权限安全 (10分)**：文件不存在-10分，路径遍历-10分，不安全路径-3分

### 部署门禁
- **≥85分**：正常部署
- **70-84分**：警告，可强制部署（需要force参数）
- **<70分**：拒绝部署

## ✅ 验证结果

### 安全漏洞修复确认

1. **无法绕过检查**：所有部署都必须通过全局安全策略验证
2. **一致的标准**：所有项目使用相同的全局安全标准
3. **独立运行**：不依赖于项目本地文件
4. **强制备份**：所有部署都自动创建配置备份

### 测试场景

- ✅ 新项目（无.cursor/rules/文件）→ 仍需通过安全检查
- ✅ 现有项目 → 继续正常工作，使用全局策略
- ✅ 恶意代码 → 被全局安全扫描检测并阻止
- ✅ 配置保护 → 自动备份和冲突检测仍然有效

## 🎯 总结

通过实施全局安全策略管理器，我们彻底修复了原有的安全绕过漏洞：

1. **问题根源解决**：从依赖项目文件转为全局强制策略
2. **安全性大幅提升**：无论从哪个项目部署都必须通过安全检查
3. **维护成本降低**：用户无需在每个项目中维护安全标准文件
4. **向后兼容**：不破坏现有的工作流程

这是一个架构级别的安全增强，确保了MCP服务部署的全方位安全保护。 